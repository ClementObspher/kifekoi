name: Gestion des DÃ©pendances

on:
    # DÃ©clenchement manuel
    workflow_dispatch:
        inputs:
            update_type:
                description: "Type de mise Ã  jour"
                required: true
                default: "security"
                type: choice
                options:
                    - security
                    - all
                    - check-only
            create_pr:
                description: "CrÃ©er une Pull Request"
                required: true
                default: true
                type: boolean

    # DÃ©clenchement automatique
    schedule:
        # VÃ©rification quotidienne Ã  9h00 UTC
        - cron: "0 9 * * *"
        # VÃ©rification hebdomadaire le dimanche Ã  10h00 UTC
        - cron: "0 10 * * 0"

    # DÃ©clenchement sur push pour les vulnÃ©rabilitÃ©s critiques
    push:
        branches: [main, dev]

    # DÃ©clenchement sur pull request
    pull_request:
        branches: [main, dev]

env:
    NODE_VERSION: "18"
    NPM_VERSION: "latest"

jobs:
    # Job de vÃ©rification des dÃ©pendances
    check-dependencies:
        name: VÃ©rification des DÃ©pendances
        runs-on: ubuntu-latest
        outputs:
            vulnerabilities: ${{ steps.security-check.outputs.vulnerabilities }}
            critical: ${{ steps.security-check.outputs.critical }}
            high: ${{ steps.security-check.outputs.high }}
            outdated: ${{ steps.outdated-check.outputs.outdated }}

        steps:
            - name: Checkout du code
              uses: actions/checkout@v4

            - name: Configuration Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Installation des dÃ©pendances
              run: npm ci

            - name: VÃ©rification des vulnÃ©rabilitÃ©s de sÃ©curitÃ©
              id: security-check
              run: |
                  echo "ðŸ” VÃ©rification des vulnÃ©rabilitÃ©s de sÃ©curitÃ©..."
                  npm audit --audit-level=moderate --json > audit-report.json || true

                  # Analyse du rapport
                  if [ -f audit-report.json ]; then
                    VULNERABILITIES=$(jq -r '.metadata.vulnerabilities.total // 0' audit-report.json)
                    CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-report.json)
                    HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit-report.json)
                    
                    echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
                    echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
                    echo "high=$HIGH" >> $GITHUB_OUTPUT
                    
                    echo "ðŸ“Š VulnÃ©rabilitÃ©s dÃ©tectÃ©es: $VULNERABILITIES (Critiques: $CRITICAL, Ã‰levÃ©es: $HIGH)"
                    
                    if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                      echo "âš ï¸ VulnÃ©rabilitÃ©s critiques/Ã©levÃ©es dÃ©tectÃ©es!"
                      exit 1
                    fi
                  else
                    echo "âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e"
                    echo "vulnerabilities=0" >> $GITHUB_OUTPUT
                    echo "critical=0" >> $GITHUB_OUTPUT
                    echo "high=0" >> $GITHUB_OUTPUT
                  fi

            - name: VÃ©rification des dÃ©pendances obsolÃ¨tes
              id: outdated-check
              run: |
                  echo "ðŸ” VÃ©rification des dÃ©pendances obsolÃ¨tes..."
                  npm outdated --json > outdated-report.json || true

                  if [ -f outdated-report.json ]; then
                    OUTDATED_COUNT=$(jq 'length' outdated-report.json)
                    echo "outdated=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
                    echo "ðŸ“¦ DÃ©pendances obsolÃ¨tes: $OUTDATED_COUNT"
                  else
                    echo "outdated=0" >> $GITHUB_OUTPUT
                    echo "âœ… Toutes les dÃ©pendances sont Ã  jour"
                  fi

            - name: Upload des rapports
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-reports
                  path: |
                      audit-report.json
                      outdated-report.json
                  retention-days: 30

            - name: Commentaire sur les vulnÃ©rabilitÃ©s
              if: steps.security-check.outputs.critical != '0' || steps.security-check.outputs.high != '0'
              run: |
                  echo "ðŸš¨ **ALERTE SÃ‰CURITÃ‰** ðŸš¨" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "VulnÃ©rabilitÃ©s critiques: ${{ steps.security-check.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
                  echo "VulnÃ©rabilitÃ©s Ã©levÃ©es: ${{ steps.security-check.outputs.high }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âš ï¸ **Action requise immÃ©diatement**" >> $GITHUB_STEP_SUMMARY

    # Job de mise Ã  jour des dÃ©pendances
    update-dependencies:
        name: Mise Ã  Jour des DÃ©pendances
        runs-on: ubuntu-latest
        needs: check-dependencies
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'schedule' && needs.check-dependencies.outputs.vulnerabilities != '0') ||
            (github.event_name == 'push' && needs.check-dependencies.outputs.critical != '0') ||
            (github.event_name == 'pull_request' && needs.check-dependencies.outputs.critical != '0')

        steps:
            - name: Checkout du code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configuration Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Configuration Git
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

            - name: Sauvegarde du package.json
              run: cp package.json package.json.backup

            - name: Mise Ã  jour des vulnÃ©rabilitÃ©s de sÃ©curitÃ©
              id: security-update
              run: |
                  echo "ðŸ”’ Correction des vulnÃ©rabilitÃ©s de sÃ©curitÃ©..."
                  npm audit fix --audit-level=moderate || true

                  # VÃ©rification post-mise Ã  jour
                  npm audit --audit-level=moderate --json > audit-after.json || true
                  VULNERABILITIES_AFTER=$(jq -r '.metadata.vulnerabilities.total // 0' audit-after.json)
                  echo "vulnerabilities_after=$VULNERABILITIES_AFTER" >> $GITHUB_OUTPUT

            - name: Mise Ã  jour des dÃ©pendances (si demandÃ©)
              if: github.event.inputs.update_type == 'all'
              run: |
                  echo "ðŸ“¦ Mise Ã  jour gÃ©nÃ©rale des dÃ©pendances..."
                  npm update

            - name: Tests de validation
              run: |
                  echo "ðŸ§ª ExÃ©cution des tests de validation..."
                  npm run lint

            - name: VÃ©rification des changements
              id: changes
              run: |
                  if git diff --quiet package.json package-lock.json; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "âœ… Aucun changement dÃ©tectÃ©"
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "ðŸ“ Changements dÃ©tectÃ©s dans les dÃ©pendances"
                  fi

            - name: CrÃ©ation de Pull Request
              if: |
                  steps.changes.outputs.has_changes == 'true' &&
                  (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore(deps): mise Ã  jour des dÃ©pendances - CompÃ©tence RNCP C4.1.1"
                  title: "ðŸ”’ Mise Ã  jour des dÃ©pendances - SÃ©curitÃ© et maintenance"
                  body: |
                      ## Mise Ã  jour des DÃ©pendances - CompÃ©tence RNCP C4.1.1

                      ### ðŸ” Changements dÃ©tectÃ©s
                      - VulnÃ©rabilitÃ©s corrigÃ©es: ${{ steps.security-update.outputs.vulnerabilities_after }}
                      - Type de mise Ã  jour: ${{ github.event.inputs.update_type }}

                      ### ðŸ“‹ Checklist
                      - [ ] Tests de linting passÃ©s
                      - [ ] Aucune vulnÃ©rabilitÃ© critique
                      - [ ] CompatibilitÃ© vÃ©rifiÃ©e

                      ### ðŸ”§ Processus de validation
                      1. VÃ©rification automatique des vulnÃ©rabilitÃ©s
                      2. Mise Ã  jour sÃ©curisÃ©e des dÃ©pendances
                      3. Tests de validation
                      4. CrÃ©ation de Pull Request

                      **CompÃ©tence RNCP C4.1.1** : Gestion des mises Ã  jour des dÃ©pendances

                      ---
                      *GÃ©nÃ©rÃ© automatiquement par GitHub Actions*
                  branch: "deps/update-$(date +%Y%m%d-%H%M%S)"
                  base: main
                  delete-branch: true
                  labels: |
                      dependencies
                      security
                      automated
                      rncp-c4.1.1

            - name: Commit direct (si PR non crÃ©Ã©e)
              if: |
                  steps.changes.outputs.has_changes == 'true' &&
                  github.event.inputs.create_pr == 'false' &&
                  github.event_name == 'workflow_dispatch'
              run: |
                  git add package.json package-lock.json
                  git commit -m "chore(deps): mise Ã  jour des dÃ©pendances - CompÃ©tence RNCP C4.1.1"
                  git push

            - name: Restauration en cas d'erreur
              if: failure()
              run: |
                  echo "ðŸ”„ Restauration du package.json..."
                  cp package.json.backup package.json
                  git add package.json
                  git commit -m "revert: restauration aprÃ¨s Ã©chec de mise Ã  jour"
                  git push

    # Job de rapport et notification
    report:
        name: Rapport et Notifications
        runs-on: ubuntu-latest
        needs: [check-dependencies, update-dependencies]
        if: always()

        steps:
            - name: Download des rapports
              uses: actions/download-artifact@v4
              with:
                  name: dependency-reports

            - name: GÃ©nÃ©ration du rapport
              run: |
                  echo "# ðŸ“Š Rapport de Gestion des DÃ©pendances" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
                  echo "**Projet:** Kifekoi" >> $GITHUB_STEP_SUMMARY
                  echo "**CompÃ©tence RNCP:** C4.1.1" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ -f audit-report.json ]; then
                    echo "## ðŸ”’ VulnÃ©rabilitÃ©s de SÃ©curitÃ©" >> $GITHUB_STEP_SUMMARY
                    jq -r '.metadata.vulnerabilities | "**Total:** \(.total), **Critiques:** \(.critical), **Ã‰levÃ©es:** \(.high), **ModÃ©rÃ©es:** \(.moderate), **Faibles:** \(.low)"' audit-report.json >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ -f outdated-report.json ]; then
                    echo "## ðŸ“¦ DÃ©pendances ObsolÃ¨tes" >> $GITHUB_STEP_SUMMARY
                    OUTDATED_COUNT=$(jq 'length' outdated-report.json)
                    echo "**Nombre:** $OUTDATED_COUNT" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "## âœ… Statut de la CompÃ©tence C4.1.1" >> $GITHUB_STEP_SUMMARY
                  echo "- **Surveillance rÃ©guliÃ¨re:** âœ… AutomatisÃ©e" >> $GITHUB_STEP_SUMMARY
                  echo "- **Ã‰valuation des impacts:** âœ… Matrice de dÃ©cision" >> $GITHUB_STEP_SUMMARY
                  echo "- **IntÃ©gration sÃ©curisÃ©e:** âœ… Processus automatisÃ©" >> $GITHUB_STEP_SUMMARY
                  echo "- **Maintenance Ã  jour:** âœ… Outils et documentation" >> $GITHUB_STEP_SUMMARY
