name: VÃ©rification Quotidienne des DÃ©pendances

on:
    schedule:
        # VÃ©rification quotidienne Ã  9h00 UTC
        - cron: "0 9 * * *"
    workflow_dispatch:

jobs:
    quick-check:
        name: VÃ©rification Rapide
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Security audit
              id: audit
              run: |
                  echo "ðŸ” VÃ©rification de sÃ©curitÃ©..."
                  npm audit --audit-level=high --json > audit.json || true

                  if [ -f audit.json ]; then
                    CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit.json)
                    HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit.json)
                    
                    echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
                    echo "high=$HIGH" >> $GITHUB_OUTPUT
                    
                    if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                      echo "ðŸš¨ VulnÃ©rabilitÃ©s critiques/Ã©levÃ©es dÃ©tectÃ©es!"
                      echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
                      echo "high_count=$HIGH" >> $GITHUB_OUTPUT
                    else
                      echo "âœ… Aucune vulnÃ©rabilitÃ© critique/Ã©levÃ©e"
                    fi
                  fi

            - name: Check outdated dependencies
              id: outdated
              run: |
                  echo "ðŸ“¦ VÃ©rification des dÃ©pendances obsolÃ¨tes..."
                  npm outdated --json > outdated.json || true

                  if [ -f outdated.json ]; then
                    COUNT=$(jq 'length' outdated.json)
                    echo "outdated_count=$COUNT" >> $GITHUB_OUTPUT
                    echo "ðŸ“Š $COUNT dÃ©pendances obsolÃ¨tes"
                  else
                    echo "outdated_count=0" >> $GITHUB_OUTPUT
                    echo "âœ… Toutes les dÃ©pendances sont Ã  jour"
                  fi

            - name: Create issue if critical vulnerabilities
              if: steps.audit.outputs.critical != '0' || steps.audit.outputs.high != '0'
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: issues } = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: ['security', 'dependencies']
                      });

                      const existingIssue = issues.find(issue => 
                        issue.title.includes('VulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es')
                      );

                      if (!existingIssue) {
                        const criticalCount = '${{ steps.audit.outputs.critical }}';
                        const highCount = '${{ steps.audit.outputs.high }}';
                        
                        await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: 'ðŸš¨ VulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es - Action requise',
                          body: '## ðŸš¨ Alerte SÃ©curitÃ© - CompÃ©tence RNCP C4.1.1\n\n' +
                                '### VulnÃ©rabilitÃ©s dÃ©tectÃ©es\n' +
                                '- **Critiques:** ' + criticalCount + '\n' +
                                '- **Ã‰levÃ©es:** ' + highCount + '\n\n' +
                                '### Action requise\n' +
                                '1. ExÃ©cuter le workflow de mise Ã  jour des dÃ©pendances\n' +
                                '2. VÃ©rifier la compatibilitÃ© des mises Ã  jour\n' +
                                '3. Tester l\'application aprÃ¨s mise Ã  jour\n\n' +
                                '### Workflow recommandÃ©\n' +
                                'DÃ©clencher manuellement le workflow de mise Ã  jour via Actions > Gestion des DÃ©pendances\n\n' +
                                '---\n' +
                                '*GÃ©nÃ©rÃ© automatiquement par GitHub Actions*',
                          labels: ['security', 'dependencies', 'urgent', 'rncp-c4.1.1']
                        });
                      }

            - name: Summary
              run: |
                  echo "# ðŸ“Š VÃ©rification Quotidienne - $(date)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸ”’ SÃ©curitÃ©" >> $GITHUB_STEP_SUMMARY
                  echo "- VulnÃ©rabilitÃ©s critiques: ${{ steps.audit.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
                  echo "- VulnÃ©rabilitÃ©s Ã©levÃ©es: ${{ steps.audit.outputs.high }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸ“¦ DÃ©pendances" >> $GITHUB_STEP_SUMMARY
                  echo "- ObsolÃ¨tes: ${{ steps.outdated.outputs.outdated_count }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## âœ… CompÃ©tence RNCP C4.1.1" >> $GITHUB_STEP_SUMMARY
                  echo "- Surveillance rÃ©guliÃ¨re: âœ… AutomatisÃ©e" >> $GITHUB_STEP_SUMMARY
                  echo "- DÃ©tection des vulnÃ©rabilitÃ©s: âœ… OpÃ©rationnelle" >> $GITHUB_STEP_SUMMARY
